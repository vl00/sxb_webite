@model Sxb.Web.ViewModels.Article.ArticleDetailViewModel
@using Sxb.Web.Utils
@{
    ViewBag.Title = $"{ Model.Title}-上学帮";
    ViewBag.KeyWords = $"{ Model.Title}";
    ViewBag.Description = $"{Model.Digest}";

}
@section Styles{
    <link rel="stylesheet" href="@(ViewBag.StaticFile)/operationplateform/component/hyperlinkcard/style.css" rel="stylesheet" />
    <link rel="stylesheet" href="@(ViewBag.StaticFile)/operationplateform/component/linkcard/style.css" rel="stylesheet" />
    <link rel="stylesheet" href="@(ViewBag.StaticFile)/operationplateform/component/qacard/style.css" rel="stylesheet" />
    <link rel="stylesheet" href="@(ViewBag.StaticFile)/operationplateform/component/rendercard/style.css" rel="stylesheet" />
    <link rel="stylesheet" href="@(ViewBag.StaticFile)/css/viewer.min.css" />
    <link rel="stylesheet" href="@(ViewBag.StaticFile)/css/reply-detail.css" />
    <link rel="stylesheet" href="@(ViewBag.StaticFile)/css/comment-list.css" />
    <link rel="stylesheet" href="@(ViewBag.StaticFile)/css/article/article-detail.css" />
    @*<link rel="stylesheet" href="@(ViewBag.StaticFile)/css/swiper.css">*@
    <link rel="stylesheet" href="@ViewBag.StaticFile/css/swiper.min.css" />
    <script>
        var user = "@ViewBag.UserServiceUrl"
    </script>

}
<header class="header flex justify-content-between">
    <a class="arrow"></a>
    <span class="header-title" style="display: none;">@Model.Title</span>
    <span class=""></span>
    <span class="btn-list flex">
        <a id="cllect" class="header-icon"></a>
        <a class="header-icon share" data-title="@Model.Title" data-content="@Model.Digest" data-url="@Url.ArticleShortUrlFormat(Model.No)" data-logo="@Uri.EscapeDataString((string)ViewBag.Cover)"></a>

        <a class="other">
            <i></i>
            <i></i>
            <i></i>
        </a>
        <a href="@(ViewBag.UserServiceUrl)/contact/report?type=0&id=@Model.Id" class="complaint"></a>
    </span>
</header>
<section class="article-detail mt">
    <h1 class="article-title">@Model.Title</h1>
    <div class="article-msg">
        <span class="date">@Model.CNTime</span>
        <span class="reading-volume">阅读：@Model.ViweCount</span>
    </div>
    <div class="article-content">


        @Html.HtmlString(Model.Html)
    </div>
    <div class="open-more text-center" style="display: none;">展开全文></div>
    <div>
        @if (!Model.Author.Contains("上学帮"))
        {
            <div class="source">
                <h5>来源：@Model.Author</h5>
                <p>本文来源于@(Model.Author)，转载目的在于传递更多信息，并不代表上学帮赞同其观点和对其真实性负责。如涉及作品内容、版权和其它问题，请在30日内与上学帮联系，我们将第一时间删除内容</p>
            </div>
        }

        <ul class="qr-code text-center">
            @if (Model.CorrelationGQRCode != null && Model.CorrelationGQRCode.Any())
            {
                if (Model.CorrelationGQRCode.Count == 1)
                {
                    foreach (var item in Model.CorrelationGQRCode)
                    {
                        <li class="new-code">
                            <img src="@item.Url" alt="">
                        </li>
                    }
                }
                else
                {
                    foreach (var item in Model.CorrelationGQRCode)
                    {
                        <li>
                            <img src="@item.Url" alt="">
                        </li>
                    }
                }
            }
        </ul>
        <ul class="tag-list flex">
            @foreach (var item in Model.CorrelationTags)
            {
                <li>@item.TagName</li>

            }
        </ul>
    </div>
</section>

@if (Model.CorrelationSCMs != null && Model.CorrelationSCMs.Count > 0)
{
    <section class="school-comments">
        <h5 class="second-title">学校点评</h5>
        <ul class="comment-list">
            @foreach (var item in Model.CorrelationSCMs)
            {
                <li class="scm-li" data-id="@item.Id">
                    <a href="/comment/@(item.No).html">
                        <!-- 校方 -->
                        <div class="list-header flex justify-content-between">
                            <div class="user-msg flex">
                                <div class="head">
                                    <div><img src="@item.HeadImgUrl" alt="" /></div>
                                    @switch (item.Role)
                                    {
                                        case PMS.OperationPlateform.Domain.Enums.SCMRole.SA:
                                            <i class="icon school"></i>
                                            break;
                                        case PMS.OperationPlateform.Domain.Enums.SCMRole.GN:
                                            <i class="icon"></i>
                                            break;
                                    }
                                </div>
                                <span class="name">
                                    @item.Name
                                    @if (item.IsExprience)
                                    {<i class="identity">过来人</i>}
                                </span>
                            </div>
                            <div class="other flex">
                                @if (item.IsAuth)
                                {<i class="icon"></i>}
                                <div data-id="@item.Id" data-type="1" class="other-list-btn text-center" data-report="3">
                                    <div class="flex">
                                        <i class="round"></i>
                                        <i class="round"></i>
                                        <i class="round"></i>
                                    </div>
                                    @if (item.IsEssence)
                                    {<span>精华</span>}
                                </div>
                            </div>
                        </div>

                        <div class="school-msg">
                            <a href="/comment/school-@item.ShortSchoolNo/">
                                <p>@(item.SchoolName ?? "[暂无数据]")</p>
                                <div class="flex justify-content-between">
                                    <ul class="star flex">
                                        @for (int i = 0; i < 5; i++)
                                        {
                                            if (i < item.SchoolStarts)
                                            {
                                                <li class="score-star"><i class="icon"></i></li>
                                            }
                                            else
                                            {
                                                <li><i class="icon"></i></li>
                                            }
                                        }
                                        <li>@(item.SchoolAvgScore)</li>
                                    </ul>
                                    <span>@(item.SchoolCommentCount)条点评</span>
                                </div>
                            </a>
                        </div>

                        <p class="content">@item.Content</p>
                    </a>
                    <div class="img-list">
                        <ul class="flex justify-content-between" id="imgList">
                            @if (item.Imgs != null && item.Imgs.Count > 0)
                            {
                                @foreach (var img in item.Imgs.Take(3))
                                {
                                    <li><img src="@img" alt="" /></li>
                                }
                            }
                        </ul>
                        @if (item.Imgs != null && item.Imgs.Count > 0)
                        {
                            @if (item.Imgs.Count > 3)
                            {
                                <span class="text-center"><i class="icon"></i>@item.Imgs.Count</span>
                            }
                        }
                    </div>

                    <div class="comment-msg flex justify-content-between">
                        <div>
                            <span class="department">国际部</span>
                            <span class="time">@item.Date</span>
                        </div>
                        <div class="ctr">
                            <span class="comment"><i class="icon"></i>@item.ReplyCount</span>
                            <span class="like @(item.IsLike?"click-like":"")">
                                <i class="icon"></i>
                                <span>@item.LikeCount</span>
                            </span>
                        </div>
                    </div>

                </li>
            }
        </ul>
        <ul class="btn-list flex justify-content-between text-center">
            <li><a href="/comment/Write?eid=@(Model.CorrelationSCMs[0].SchoolExtId)" class="goto-comment">我也要评</a></li>
            <li><a href="/CommentAndQustion" class="more-comment">更多点评</a></li>
        </ul>
    </section>
}

@if (Model.CorrelationSchoolExt != null && Model.CorrelationSchoolExt.Any())
{
    <section class="relevant-schools">
        <h5 class="second-title">相关学校</h5>
        <ul class="content-list">

            @await Html.PartialAsync("../School/_Original.cshtml", (IEnumerable<Sxb.Web.ViewModels.School.SchoolExtListItemViewModel>)Model.CorrelationSchoolExt)
        </ul>
        <div class="swiper-container ad-img">
            <div class="swiper-wrapper">
            </div>
            <div class="swiper-pagination mkt-pagination"></div>
        </div>
    </section>
}

<section class="related-articles" style="margin-bottom: 0;">

    <h5 class="second-title">相关文章</h5>
    <ul class="related-list">
        @if (Model.CorrelationArticle != null && Model.CorrelationArticle.Count > 0)
        {
            @foreach (var article in Model.CorrelationArticle)
            {

                switch (article.Layout)
                {

                    case 1:
                        //单小图文章
                        <li>
                            <a href="@Url.Action("detail","article",new { no = article.No})" class="flex justify-content-between">
                                <div class="text-msg">
                                    <h6 class="article-title">@article.Title</h6>
                                    <div>
                                        <span class="time">@article.CNTime</span>
                                        <span class="check-num"><i class="article-icon"></i>@article.ViweCount</span>
                                    </div>
                                </div>
                                <div class="img"><img src="@article.Covers?.FirstOrDefault()" alt="" /></div>
                            </a>
                        </li>
                        break;
                    case 2:
                        //单大图文章
                        <li>
                            <a href="@Url.Action("detail","article",new { no = article.No})" class="article-detail">
                                <div class="text-msg"><h5 class="article-title">@article.Title</h5></div>
                                <div class="img-box"><img src="@article.Covers?.FirstOrDefault()" alt="" /></div>
                                @*<p class="article-content">@article.Digest</p>*@
                                <div>
                                    <span class="time">@article.CNTime</span>
                                    <span class="check-num"><i class="article-icon"></i>@article.ViweCount</span>
                                </div>
                            </a>
                        </li>
                        break;
                    default:
                        //无图文章
                        <li>
                            <a href="@Url.Action("detail","article",new { no = article.No})">
                                <div class="text-msg" style="width:100%;">
                                    <h6 class="article-title" style="margin-bottom: .5rem;">@article.Title</h6>
                                    <div>
                                        <span class="time">@article.CNTime</span>
                                        <span class="check-num"><i class="article-icon"></i>@article.ViweCount</span>
                                    </div>
                                </div>
                            </a>
                        </li>
                        break;
                }
            }
        }
    </ul>
</section>
<div class="text-center bottom-line not-more-data">广州市藏星网络科技有限公司</div>

@if ((Model.FirstSchoolBranchs?.Any()).GetValueOrDefault())
{
    <div class="question-btn"><i class="article-icon"></i></div>
    <section class="popup-question">
        <div class="popup-content">
            @if (Model.FirstSchoolBranchs != null && Model.FirstSchoolBranchs.Count > 0)
            {
                <form id="submit-question" data-url="">
                    <div class="question-box">
                        <h5 class="select-school-name flex justify-content-between">
                            <span>
                                @{
                                    var first_branch = Model.FirstSchoolBranchs.FirstOrDefault();
                                }
                                @(first_branch.Parent.name + " - " + first_branch.name)
                            </span>
                            <i class="arrow-down"></i>
                            <input type="hidden" name="schoolId" value="@first_branch.id" />
                        </h5>
                        <ul class="drop-down">
                            <li class="active" data-id="@first_branch.id">@first_branch.Parent.name - @first_branch.name</li>
                            @for (int i = 1; i < Model.FirstSchoolBranchs.Count; i++)
                            {
                                var item = Model.FirstSchoolBranchs[i];
                                <li data-id="@item.id">@item.Parent.name - @item.name</li>
                            }
                            <li class="other-school">其它学校</li>
                        </ul>
                    </div>
                    <div class="textarea">
                        <textarea name="qcontent" id="" cols="30" rows="10" placeholder="学校成绩排名如何？师资是否靠谱？…… 亲，马上提出您的疑问吧！"></textarea>
                    </div>
                    <div class="upload-img flex">
                        <ul class="img-list flex">
                            <li class="upload-btn text-center">
                                <p><i class="article-icon"></i></p>
                                <p>上传照片</p>
                                <input type="file" accept="image/*" id="submit_question_imgs" />
                            </li>
                        </ul>
                    </div>
                    <a class="submit-question-btn text-center">发布</a>
                </form>
            }

            <h5 class="qa-title text-center" style="display:none;">你问我答</h5>
            <div id="collect_qa_card"></div>
        </div>
        <div class="search-content">
            <div class="flex">
                <div class="search-input">
                    <input type="text" id="search-other-school" placeholder="请输入学校名称">
                    <i class="reset-input"></i>
                </div>
                <span class="search-cancel text-center">取消</span>
            </div>
            <ul class="search-list" id="searchList"></ul>
        </div>
    </section>
}

<div class="popup-box">
    <ul class="text-center">
        <li class="reply-btn"><a>回复</a></li>
        <li class="complaint"><a href="#">举报</a></li>
        <li class="popup-cancel"><a>取消</a></li>
    </ul>
</div>

<section class="reply-box">
    <div class="flex justify-content-between btn-list">
        <span class="cancel">取消</span>
        <div>
            @if (ViewBag.isSchoolRole)
            {
                <span id="Rumor" class="btn"><i class="round"></i>学校辟谣</span><!-- 其他用户则改成"在读" -->
            }
            else
            {
                <span id="Student" class="btn"><i class="round"></i>在读</span>
            }
            <span id="anonymous" class="btn"><i class="round"></i>匿名</span>
            <span class="submit-reply">发布</span>
        </div>
    </div>
    <textarea name="" id="reply" cols="30" rows="8" placeholder="回复楼主:"></textarea>
</section>
<!-- 幕布 -->
<div class="curtain"></div>
<!-- 幕布 -->
<div class="curtain2"></div>

<!-- 头部其他内容按钮 -->
<div class="popup-other text-center">
    <ul>
        <li class="complaint"><a href="@(ViewBag.UserServiceUrl)/contact/report?type=0&id=@Model.Id">举报</a></li>
        <li class="cancel"><a>取消</a></li>
    </ul>
</div>

<!-- 弹窗交互 -->
<div class="WarningBox">
    <i class="warning-i"></i>
    <span class="content">您发布的内容包含敏感词，<br>请重新编辑后再发布。</span>
    <a class="btn">确认</a>
    <a class="btn" style="display:none;" href="#">绑定手机</a>
</div>

@section Scripts{

    <script src="@(ViewBag.StaticFile)/js/viewer.min.js"></script>
    <script src="@(ViewBag.StaticFile)/js/collection.js"></script>
    <script src="@(ViewBag.StaticFile)/js/article/article-detail.js"></script>
    <!--卡片所需要的js-->
    @*<script src="@(ViewBag.StaticFile)/operationplateform/component/qacard/qacard.js"></script>*@
    <script src="@(ViewBag.StaticFile)/operationplateform/component/rendercard/rendercard.js"></script>
    @*<script src="https://cdn.sxkid.com/v4source/pc/js/swiper.js"></script>*@
    <script src="@ViewBag.StaticFile/js/swiper.min.js"></script>
    <script>
                var dataID = '@Model.Id';
                var dataType = 0;
                $(function () {
                    if (navigator.userAgent.toLowerCase().match(/WindowsWechat/i) == "windowswechat")
                        document.title = "上学帮";
                    $.isCollection(dataID);
                    //点击收藏
                    $("#cllect").on("click", function () {
                        // 收藏
                        $.collection(dataID, dataType, "");
                    });

                    //将该地址写入点评出口位置
                    localStorage.setItem("CommentEntrance", document.location.href)

                    //提问地址
                    localStorage.setItem("QuestionEntrance", document.location.href)
                });
    </script>
    <script>
        function FormDic(formElement) {
            var p_arr = $(formElement).serializeArray();
            var p_obj = {};
            p_arr.forEach(function (v, i, kv) {
                p_obj[v.name] = v.value
            });
            return p_obj;

        }

        //提问模型
        var QuestionInfo = function (SchoolId, SchoolSectionId, Content, IsAnony) {
            this.SchoolId = SchoolId;
            this.SchoolSectionId = SchoolSectionId;
            this.Content = Content;
            this.IsAnony = IsAnony;
        }
        function CommitQuestion(question, images, questionId) {
            $.ajax({
                url: "/Question/CommitQuestion", type: "POST", data: { question: question, questionId: questionId, questionImages: images },
                beforeSend: function () {
                    $.loading()
                },
                success: function (data) {
                    if (data.succeed) {
                        if (data.status == 200) {
                            $('.comment-content textarea').val("")
                            location.href = "/Question/QuestionSuccess?SchoolId=" + data.data.schoolId + "&QuestionId=" + data.data.dataId + "&isSuccessQuestion=true";
                        }
                        else if (data.status == 402) {
                            var path = window.location.href;
                            window.location.href = data.data.loginUrl + path;
                        }
                        else {
                            alert(data.msg);
                        }
                    }
                    else {
                        if (data.data.errorCode === 40004) {
                            $(".WarningBox .btn").last().removeAttr('style').attr('href', data.data.bindUrl);
                        }
                        $(".popup-question").hide()
                        $(".WarningBox .content").empty().append(data.msg)
                        $(".curtain,.WarningBox").show()
                    }
                }
            })
        }

        $('.submit-question-btn').click(function () {

            var formParms = FormDic($('#submit-question'));
            if (!formParms['qcontent'] || formParms['qcontent'].length <= 0) {
                alert('请填写问题内容。');
                return;
            }

            var images = [];
            //$(".upload-img .img-list li").each(function (i, e) {
            //    if ($(this).attr("data-isuploadimage") == "true") {
            //        //images.append(i, $(this).find("img").attr("src"))
            //        images[i] = $(this).find("img").attr("src")
            //    }
            //})

            $(".upload-img .img-list li").each(function (i, e) {
                if (i == $(".upload-img .img-list li").length - 1) {
                    return;
                }
                images[i] = $(this).find("img").attr("src")
            })
            $.loading();

            var question = new QuestionInfo('00000000-0000-0000-0000-000000000000', formParms['schoolId'], formParms['qcontent'], false);
            if ($(".upload-img .img-list li").length > 0) {
                $.ajax({
                    url: "/Common/AppUploadImager",
                    type: "POST",
                    data: { imagesArr: images },
                    beforeSend: function () {
                        //$.loading("数据提交中")
                    },
                    success: function (data) {
                        if (data.status == 200) {
                            CommitQuestion(question, data.data.imagerUrl, data.data.id);
                        }
                        else if (data.status == 402) {
                            var path = window.location.href;
                            window.location.href = data.data.loginUrl + path;
                        }
                        else {
                            alert(data.msg);
                        }
                    },
                    complete: function () {
                        $.loading('remove');
                    }
                })
            }
            else {
                let images = []
                CommitQuestion(question, images, $.newGuid());
            }
        })
    </script>
    <script>
        var lock = null;

        var searchInput = $('#search-other-school');
        var searchList = $('#searchList');

        function SearchListItemTemplate(item) {
            var template = '';
            template += '<li data-id="' + item.id + '">' + item.name + '</li>';
            return template;
        }
        var timer;
        function init() {
            searchInput.on('input', () => {
                clearTimeout(timer);
                timer = setTimeout(() => {
                    $.loading();
                    LoadSearchSchoolDatas({
                        searchName: searchInput.val(),
                        offset: 0,
                        limit: 20
                    }, (res) => {
                        if (res.status == 1) {
                            searchList.empty();
                            $.each(res.data, (index, value) => {
                                searchList.append(SearchListItemTemplate(value));
                            })
                        } else {
                            alert(res.msg);
                        }
                    }, () => {
                        $.loading('remove');
                        lock = 0;   //释放锁
                    });

                }, 2000);

            })

            searchList.on('click', 'li', function () {
                var id = $(this).data('id');
                $('input[name="schoolId"]').val(id);
            });

            $('.popup-question .drop-down').on('click', 'li', function () {
                var id = $(this).data('id');
                $('input[name="schoolId"]').val(id);
            })
        }

        function LoadSearchSchoolDatas(params, success, complete) {
            $.ajax({
                url: '/article/SearchSchool',
                type: 'get',
                data: params,
                success: success,
                complete: complete
            });

        }

        $(document).ready(function () {
            init();

        });
    </script>
}